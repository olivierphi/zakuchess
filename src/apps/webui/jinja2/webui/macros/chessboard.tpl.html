{% macro board_whole(game, board_state, board_id="main", piece_available_targets=None) -%}
    <div class="chess-board-container" id="chess-board-container-{{ board_id }}">
        {{ board_background(board_id=board_id) }}
        {{ board_pieces(game, board_state, board_id=board_id) }}
        {{ board_piece_available_targets(game, piece_available_targets, board_id=board_id) }}
    </div>
{% endmacro -%}

{% macro board_background(board_id="main") -%}
    <div class="chess-board-background" id="chess-board-background-{{ board_id }}">
        {% for letter in "abcdefgh" %}
            {% for number in "12345678" %}
                <div class="square square-{{ letter }}{{ number }} {{ "square-odd-row" if letter in "bdfh" else "square-even-row" }}">
                    <div class="square-debug">{{ letter }}{{ number }}</div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
{%- endmacro %}

{% macro board_pieces(game, board_state, board_id="main") -%}
    <div class="chess-board-pieces" id="chess-board-pieces-{{ board_id }}">
        {% for square, piece in board_state.pieces_view.items() %}
            {% set belongs_to_active_player = piece.piece|player_side_from_piece == board_state.active_player %}
            <div class="piece square square-{{ square }} 
                piece-{{ piece.piece }} 
                side-{{ piece.piece|player_side_from_piece }}
                {{ "active-player" if belongs_to_active_player else "" }}
            "
                 id="board-{{ board_id }}-piece-{{ piece.id }}"
                 {%- if belongs_to_active_player -%}
                    data-hx-get="/htmx/games/{{ game.id }}/pieces/{{ square }}/selection/"
                    data-hx-target="#chess-board-available-targets-{{ board_id }}"
                    data-hx-swap="outerHTML"
                 {%- endif %}
            >
                <div class="piece-display"></div>
                <div class="piece-debug">{{ piece.piece|piece_unicode_from_symbol }}<small>#{{ piece.id }}</small></div>
            </div>
        {% endfor %}
    </div>
    {# TODO: de-harcode this: #}
    {% if game.is_versus_bot and game.active_player == "b" %}
        {% set actionHolderUniqueId = "chess-board-next-bot-action-" ~ board_id ~ "-" ~ uuid() %}
        <div id="{{ actionHolderUniqueId }}" 
            data-hx-post="/htmx/games/{{ game.id }}/pieces/${fromSquare}/move/${toSquare}/"
            data-hx-target="#chess-board-pieces-{{ board_id }}"
            data-hx-swap="outerHTML"
        ></div>
        <script>
            window.zakuchess.bot.playFromFEN({{ board_state.fen|tojson }}, 3, "{{ actionHolderUniqueId }}")
        </script>
    {% endif %}    
{%- endmacro %}

{% macro board_piece_available_targets(game, piece_available_targets, selected_piece_square, board_id="main") -%}
    <div class="chess-board-available-targets" id="chess-board-available-targets-{{ board_id }}" 
         style="display: {{ "block" if piece_available_targets else "none" }}">
        {% for square in piece_available_targets|default([], boolean=true) %}
            <div class="target square square-{{ square }}" 
                 data-hx-post="/htmx/games/{{ game.id }}/pieces/{{ selected_piece_square }}/move/{{ square }}/"
                 data-hx-target="#chess-board-pieces-{{ board_id }}"
                 data-hx-swap="outerHTML"
            >
            </div>
        {% endfor %}
    </div>    
{%- endmacro %}
